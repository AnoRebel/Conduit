import{J as K,K as F,k as T,L,r as i,x as O,M as D}from"./BH7xsakx.js";function P(){const y=K().public.adminApiUrl,o=F("apiKey",()=>""),r=T(()=>!!o.value);function m(e){o.value=e,localStorage.setItem("adminApiKey",e)}function f(){{const e=localStorage.getItem("adminApiKey");e&&(o.value=e)}}async function t(e,c={}){const A={"Content-Type":"application/json",...c.headers};o.value&&(A["X-API-Key"]=o.value);const M=await fetch(`${y}${e}`,{...c,headers:A});if(!M.ok){const $=await M.json().catch(()=>({}));throw new Error($.error||`HTTP ${M.status}`)}return M.json()}async function g(){return t("/status")}async function d(){return t("/health")}async function n(){return t("/metrics")}async function v(e="1h"){return t(`/metrics/history?duration=${e}`)}async function C(){return t("/clients")}async function E(e){return t(`/clients/${encodeURIComponent(e)}`)}async function p(e){return t(`/clients/${encodeURIComponent(e)}`,{method:"DELETE"})}async function b(){return t("/clients",{method:"DELETE"})}async function w(){return t("/bans")}async function h(e,c){return t(`/bans/client/${encodeURIComponent(e)}`,{method:"POST",body:JSON.stringify({reason:c})})}async function a(e){return t(`/bans/client/${encodeURIComponent(e)}`,{method:"DELETE"})}async function S(e,c){return t(`/bans/ip/${encodeURIComponent(e)}`,{method:"POST",body:JSON.stringify({reason:c})})}async function u(e){return t(`/bans/ip/${encodeURIComponent(e)}`,{method:"DELETE"})}async function l(e=100){return t(`/audit?limit=${e}`)}async function U(){return t("/config")}async function R(e){return t("/config/rate-limit",{method:"PATCH",body:JSON.stringify(e)})}async function I(e,c){return t("/broadcast",{method:"POST",body:JSON.stringify({type:e,payload:c})})}return{apiKey:L(o),isAuthenticated:r,setApiKey:m,loadApiKey:f,fetchApi:t,getStatus:g,getHealth:d,getMetrics:n,getMetricsHistory:v,getClients:C,getClient:E,disconnectClient:p,disconnectAllClients:b,getBans:w,banClient:h,unbanClient:a,banIP:S,unbanIP:u,getAuditLog:l,getConfig:U,updateRateLimits:R,broadcast:I}}function H(){const s=K(),{apiKey:y}=P(),o=i(null),r=i(!1),m=i(null),f=i(null),t=i(0),g=5;let d=null;const n={onMetrics:new Set,onClientConnected:new Set,onClientDisconnected:new Set,onError:new Set};function v(){if(!s.public.adminWsUrl){console.warn("WebSocket URL not configured");return}if(o.value?.readyState===WebSocket.OPEN)return;const a=new URL(s.public.adminWsUrl);y.value&&a.searchParams.set("apiKey",y.value),o.value=new WebSocket(a.toString()),o.value.onopen=()=>{r.value=!0,t.value=0,o.value?.send(JSON.stringify({type:"subscribe",data:{events:["metrics:update","client:connected","client:disconnected","error:occurred"]}}))},o.value.onmessage=S=>{try{const u=JSON.parse(S.data);switch(m.value=u,u.type){case"metrics:update":f.value=u.data,n.onMetrics.forEach(l=>l(u.data));break;case"client:connected":n.onClientConnected.forEach(l=>l(u.data));break;case"client:disconnected":n.onClientDisconnected.forEach(l=>l(u.data));break;case"error:occurred":n.onError.forEach(l=>l(u.data));break}}catch{}},o.value.onclose=()=>{r.value=!1,E()},o.value.onerror=()=>{r.value=!1}}function C(){d&&(clearTimeout(d),d=null),o.value&&(o.value.close(),o.value=null),r.value=!1}function E(){if(t.value>=g)return;const a=Math.min(1e3*2**t.value,3e4);t.value++,d=setTimeout(()=>{v()},a)}function p(a){return n.onMetrics.add(a),()=>n.onMetrics.delete(a)}function b(a){return n.onClientConnected.add(a),()=>n.onClientConnected.delete(a)}function w(a){return n.onClientDisconnected.add(a),()=>n.onClientDisconnected.delete(a)}function h(a){return n.onError.add(a),()=>n.onError.delete(a)}return O(()=>{C()}),{isConnected:L(r),lastMessage:L(m),lastMetrics:L(f),connect:v,disconnect:C,onMetrics:p,onClientConnected:b,onClientDisconnected:w,onError:h}}const N=D("admin",()=>{const s=P(),y=H(),o=i(null),r=i(null),m=i([]),f=i([]),t=i([]),g=i([]),d=i(!1),n=i(null),v=T(()=>o.value?.running??!1),C=T(()=>f.value.length),E=T(()=>f.value.filter(e=>e.connected).length);async function p(){try{o.value=await s.getStatus()}catch(e){n.value=e instanceof Error?e.message:"Failed to fetch status"}}async function b(){try{r.value=await s.getMetrics()}catch(e){n.value=e instanceof Error?e.message:"Failed to fetch metrics"}}async function w(e="1h"){try{const c=await s.getMetricsHistory(e);m.value=c.snapshots}catch(c){n.value=c instanceof Error?c.message:"Failed to fetch metrics history"}}async function h(){try{const e=await s.getClients();f.value=e.clients}catch(e){n.value=e instanceof Error?e.message:"Failed to fetch clients"}}async function a(){try{const e=await s.getBans();t.value=e.bans}catch(e){n.value=e instanceof Error?e.message:"Failed to fetch bans"}}async function S(e=100){try{const c=await s.getAuditLog(e);g.value=c.entries}catch(c){n.value=c instanceof Error?c.message:"Failed to fetch audit log"}}async function u(e){try{await s.disconnectClient(e),await h()}catch(c){n.value=c instanceof Error?c.message:"Failed to disconnect client"}}async function l(e,c){try{await s.banClient(e,c),await a()}catch(A){n.value=A instanceof Error?A.message:"Failed to ban client"}}async function U(e){try{await s.unbanClient(e),await a()}catch(c){n.value=c instanceof Error?c.message:"Failed to unban client"}}async function R(){d.value=!0,n.value=null;try{await Promise.all([p(),b(),h(),a()]),y.connect(),y.onMetrics(e=>{r.value=e})}catch(e){n.value=e instanceof Error?e.message:"Failed to initialize"}finally{d.value=!1}}function I(){y.disconnect()}return{status:o,metrics:r,metricsHistory:m,clients:f,bans:t,auditLog:g,isLoading:d,error:n,isConnected:v,clientCount:C,connectedClientCount:E,fetchStatus:p,fetchMetrics:b,fetchMetricsHistory:w,fetchClients:h,fetchBans:a,fetchAuditLog:S,disconnectClient:u,banClient:l,unbanClient:U,initialize:R,cleanup:I}});export{P as a,N as u};
